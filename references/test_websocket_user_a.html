<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - User A (Sender)</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a2e1a; color: #0f0; }
        #log { background: #000; padding: 15px; height: 300px; overflow-y: auto; border: 1px solid #0f0; }
        .log-entry { margin: 5px 0; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .info { color: #0ff; }
        .warn { color: #ff0; }
        .message { color: #fff; background: #333; padding: 5px; border-radius: 5px; }
        input, button { padding: 10px; margin: 5px; font-family: monospace; }
        input { width: 350px; background: #2a4a2a; color: #fff; border: 1px solid #0f0; }
        button { background: #0f0; color: #000; border: none; cursor: pointer; }
        button:hover { background: #0a0; }
        button:disabled { background: #444; cursor: not-allowed; color: #666; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #4a6a4a; border-radius: 10px; }
        h3 { color: #0f0; margin-top: 0; }
        .chat-box { background: #0a1a0a; padding: 15px; min-height: 200px; max-height: 400px; overflow-y: auto; border-radius: 5px; margin: 10px 0; }
        .chat-msg { padding: 8px 12px; margin: 5px 0; border-radius: 10px; max-width: 80%; }
        .chat-msg.received { background: #2196F3; margin-right: auto; }
        .chat-msg.sent { background: #4CAF50; margin-left: auto; }
        .chat-msg .meta { font-size: 10px; opacity: 0.7; margin-top: 5px; }
        .status { display: inline-block; padding: 5px 15px; border-radius: 15px; margin: 5px 0; }
        .status.connected { background: #4CAF50; color: #fff; }
        .status.disconnected { background: #f44336; color: #fff; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 5px; }
        .btn-primary { background: #4CAF50; }
        .btn-danger { background: #f44336; }
        .btn-secondary { background: #2196F3; color: #fff; }
        h1 { color: #4CAF50; }
        .conv-list { background: #1a2a1a; padding: 10px; border-radius: 5px; margin: 10px 0; max-height: 150px; overflow-y: auto; }
        .conv-item { padding: 8px; margin: 3px 0; background: #2a3a2a; border-radius: 5px; cursor: pointer; }
        .conv-item:hover { background: #3a4a3a; }
        .conv-item.selected { background: #4CAF50; color: #000; }
    </style>
</head>
<body>
    <h1>üë§ User A - Chat Sender Test</h1>
    <p>Use this to create conversations and send messages</p>

    <div class="section">
        <h3>1. Connect</h3>
        <span class="status disconnected" id="status">Disconnected</span><br><br>
        <label>Server URL:</label><br>
        <input type="text" id="serverUrl" value="http://localhost:5000" /><br>
        <label>JWT Token (User A):</label><br>
        <input type="text" id="token" placeholder="Paste User A's JWT token here" /><br>
        <div class="btn-group">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()" id="disconnectBtn" disabled class="btn-danger">Disconnect</button>
            <button onclick="sendPing()" id="pingBtn" disabled>Ping</button>
        </div>
    </div>

    <div class="section">
        <h3>2. My Conversations</h3>
        <div class="btn-group">
            <button onclick="loadConversations()" id="loadConvsBtn" disabled>Refresh Conversations</button>
        </div>
        <div class="conv-list" id="convList">
            <div style="color: #666; text-align: center;">Conversations will appear here after connecting...</div>
        </div>
    </div>

    <div class="section">
        <h3>3. Create New Conversation</h3>
        <label>Target User Key (User B):</label><br>
        <input type="text" id="targetUserKey" placeholder="Enter User B's user_key" /><br>
        <label>Conversation Type:</label><br>
        <select id="convType" style="padding: 10px; margin: 5px; background: #2a4a2a; color: #fff; border: 1px solid #0f0;">
            <option value="direct">Direct (1-on-1)</option>
            <option value="group">Group</option>
        </select><br>
        <label>Group Name (optional):</label><br>
        <input type="text" id="groupName" placeholder="Group name (for group chats only)" /><br>
        <button onclick="createConversation()" id="createConvBtn" disabled class="btn-primary">Create Conversation</button>
    </div>

    <div class="section">
        <h3>4. Current Conversation</h3>
        <label>Conversation ID:</label><br>
        <input type="text" id="conversationId" placeholder="Selected conversation ID" /><br>
        <div class="btn-group">
            <button onclick="loadMessages()" id="loadMsgsBtn" disabled class="btn-secondary">Load Messages</button>
            <button onclick="joinConversation()" id="joinBtn" disabled>Join Room</button>
        </div>
    </div>

    <div class="section">
        <h3>5. Chat</h3>
        <div class="chat-box" id="chatBox">
            <div style="color: #666; text-align: center;">Messages will appear here...</div>
        </div>
        <input type="text" id="messageInput" placeholder="Type a message..." style="width: calc(100% - 120px);" />
        <button onclick="sendMessage()" id="sendBtn" disabled class="btn-primary">Send</button>
        <div class="btn-group" style="margin-top: 10px;">
            <button onclick="markAsRead()" id="readBtn" disabled>Mark as Read</button>
            <button onclick="startTyping()" id="typingBtn" disabled>Typing...</button>
            <button onclick="clearConversation(false)" id="clearMeBtn" disabled class="btn-secondary">Clear (Me Only)</button>
            <button onclick="clearConversation(true)" id="clearAllBtn" disabled class="btn-danger">Clear (Everyone)</button>
        </div>
        <div style="margin-top: 10px;">
            <label>Message ID to Delete:</label><br>
            <input type="text" id="deleteMessageId" placeholder="Enter message ID" style="width: 250px;" />
            <button onclick="deleteMessage(false)" id="deleteMeBtn" disabled>Delete (Me)</button>
            <button onclick="deleteMessage(true)" id="deleteAllBtn" disabled class="btn-danger">Delete (All)</button>
        </div>
    </div>

    <div class="section">
        <h3>6. Event Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log"></div>
    </div>

    <script>
        let socket = null;
        let currentConversationId = null;
        let userKey = null;
        let conversations = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function addChatMessage(content, isSent, meta = '', messageId = '') {
            const chatBox = document.getElementById('chatBox');
            // Remove placeholder if exists
            const placeholder = chatBox.querySelector('div[style*="color: #666"]');
            if (placeholder) {
                chatBox.innerHTML = '';
            }
            const msg = document.createElement('div');
            msg.className = `chat-msg ${isSent ? 'sent' : 'received'}`;
            const idDisplay = messageId ? `<span style="font-size: 9px; opacity: 0.5; cursor: pointer;" onclick="document.getElementById('deleteMessageId').value='${messageId}'" title="Click to copy ID">[${messageId.slice(-8)}]</span>` : '';
            msg.innerHTML = `${content}<div class="meta">${meta} ${idDisplay}</div>`;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function setStatus(connected) {
            const status = document.getElementById('status');
            status.textContent = connected ? 'Connected' : 'Disconnected';
            status.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function setButtonsEnabled(enabled) {
            document.getElementById('disconnectBtn').disabled = !enabled;
            document.getElementById('pingBtn').disabled = !enabled;
            document.getElementById('loadConvsBtn').disabled = !enabled;
            document.getElementById('createConvBtn').disabled = !enabled;
            document.getElementById('loadMsgsBtn').disabled = !enabled;
            document.getElementById('joinBtn').disabled = !enabled;
            document.getElementById('sendBtn').disabled = !enabled;
            document.getElementById('readBtn').disabled = !enabled;
            document.getElementById('typingBtn').disabled = !enabled;
            document.getElementById('clearMeBtn').disabled = !enabled;
            document.getElementById('clearAllBtn').disabled = !enabled;
            document.getElementById('deleteMeBtn').disabled = !enabled;
            document.getElementById('deleteAllBtn').disabled = !enabled;
        }

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            const token = document.getElementById('token').value;

            if (!token) {
                log('ERROR: Please enter a JWT token!', 'error');
                return;
            }

            log(`Connecting to ${serverUrl}...`, 'info');

            try {
                socket = io(serverUrl, {
                    auth: { token: token },
                    transports: ['websocket', 'polling'],
                    reconnection: true,
                    reconnectionAttempts: 3,
                    timeout: 10000,
                });

                // Connection Events
                socket.on('connect', () => {
                    log(`‚úÖ CONNECTED! Socket ID: ${socket.id}`, 'success');
                    setStatus(true);
                    setButtonsEnabled(true);
                });

                socket.on('disconnect', (reason) => {
                    log(`‚ùå DISCONNECTED: ${reason}`, 'warn');
                    setStatus(false);
                    setButtonsEnabled(false);
                });

                socket.on('connect_error', (error) => {
                    log(`‚ùå CONNECTION ERROR: ${error.message}`, 'error');
                });

                socket.on('connected', (data) => {
                    log(`‚úÖ AUTHENTICATED as: ${data.user_key}`, 'success');
                    userKey = data.user_key;
                    log(`üìã Your user_key: ${userKey}`, 'info');
                    // Auto-load conversations after authentication
                    log('üìã Auto-loading conversations...', 'info');
                    loadConversations();
                });

                socket.on('error', (error) => {
                    log(`‚ùå SERVER ERROR: ${JSON.stringify(error)}`, 'error');
                });

                // Chat Events
                socket.on('chat:message', (data) => {
                    log(`üì® NEW MESSAGE from ${data.senderKey}: ${data.content}`, 'message');
                    if (data.conversationId === currentConversationId) {
                        addChatMessage(data.content, false, `From: ${data.senderName || data.senderKey} ‚Ä¢ ${new Date(data.createdAt).toLocaleTimeString()}`, data.messageId);
                    }
                });

                socket.on('chat:message:sent', (data) => {
                    log(`‚úÖ Message sent: ${data.messageId}`, 'success');
                    addChatMessage(data.content, true, `Sent ‚Ä¢ ${new Date().toLocaleTimeString()}`, data.messageId);
                });

                socket.on('chat:message:delivered', (data) => {
                    log(`üì¨ Delivered to ${data.deliveredTo}: ${data.messageId}`, 'success');
                });

                socket.on('chat:message:read', (data) => {
                    log(`üëÅ Read by ${data.readBy}`, 'success');
                });

                socket.on('chat:typing:start', (data) => {
                    log(`‚å®Ô∏è ${data.userKey} is typing...`, 'info');
                });

                socket.on('chat:typing:stop', (data) => {
                    log(`‚å®Ô∏è ${data.userKey} stopped typing`, 'info');
                });

                socket.on('chat:error', (data) => {
                    log(`‚ùå CHAT ERROR: ${data.code} - ${data.message}`, 'error');
                });

                socket.on('chat:message:deleted', (data) => {
                    log(`üóëÔ∏è Message deleted: ${data.messageId} (forEveryone: ${data.forEveryone})`, 'warn');
                    // Reload messages to reflect deletion
                    if (currentConversationId) {
                        loadMessages();
                    }
                });

                socket.on('chat:conversation:cleared', (data) => {
                    log(`üßπ Conversation cleared: ${data.conversationId} (${data.messagesCleared} messages)`, 'warn');
                    // Reload messages to reflect clear
                    if (currentConversationId === data.conversationId) {
                        loadMessages();
                    }
                });

                socket.on('chat:conversation:created', (data) => {
                    log(`üí¨ Conversation created: ${data.conversationId}`, 'success');
                    document.getElementById('conversationId').value = data.conversationId;
                    currentConversationId = data.conversationId;
                    // Reload conversations
                    loadConversations();
                });

                socket.on('chat:conversation:joined', (data) => {
                    log(`üö™ Joined room: ${data.conversationId}`, 'success');
                });

                // Notification Events
                socket.on('notification:new', (data) => {
                    log(`üîî Notification: ${JSON.stringify(data)}`, 'info');
                });

                socket.on('pong', (data) => {
                    log(`üèì PONG: ${JSON.stringify(data)}`, 'success');
                });

            } catch (error) {
                log(`‚ùå EXCEPTION: ${error.message}`, 'error');
            }
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                log('Disconnected manually', 'warn');
                setStatus(false);
                setButtonsEnabled(false);
            }
        }

        function sendPing() {
            if (socket && socket.connected) {
                log('üèì Sending PING...', 'info');
                socket.emit('ping');
            } else {
                log('Not connected!', 'error');
            }
        }

        async function loadConversations() {
            const token = document.getElementById('token').value;
            const serverUrl = document.getElementById('serverUrl').value;

            if (!token) {
                log('‚ùå No token available for API call', 'error');
                return;
            }

            log('üìã Loading conversations via REST API...', 'info');

            try {
                const response = await fetch(`${serverUrl}/api/chat/conversations`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    conversations = data.data.conversations || [];
                    log(`‚úÖ Found ${conversations.length} conversations`, 'success');

                    renderConversationList();

                    if (conversations.length > 0) {
                        // Auto-select first conversation
                        selectConversation(conversations[0].id);
                    }
                } else {
                    log(`‚ùå Error: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå API Error: ${error.message}`, 'error');
            }
        }

        function renderConversationList() {
            const convList = document.getElementById('convList');

            if (conversations.length === 0) {
                convList.innerHTML = '<div style="color: #666; text-align: center;">No conversations yet. Create one below!</div>';
                return;
            }

            convList.innerHTML = '';
            conversations.forEach((conv, i) => {
                const div = document.createElement('div');
                div.className = `conv-item ${conv.id === currentConversationId ? 'selected' : ''}`;
                div.onclick = () => selectConversation(conv.id);

                const participants = conv.participants?.filter(p => p !== userKey).join(', ') || 'No other participants';
                const lastMsg = conv.lastMessage?.content || 'No messages yet';

                div.innerHTML = `
                    <strong>${conv.type === 'group' ? 'üë•' : 'üë§'} ${conv.name || participants}</strong><br>
                    <small style="opacity: 0.7;">${lastMsg.substring(0, 30)}${lastMsg.length > 30 ? '...' : ''}</small>
                `;
                convList.appendChild(div);
            });
        }

        function selectConversation(convId) {
            currentConversationId = convId;
            document.getElementById('conversationId').value = convId;
            log(`üìå Selected conversation: ${convId}`, 'info');

            // Update UI
            renderConversationList();

            // Auto-join room
            if (socket && socket.connected) {
                socket.emit('chat:conversation:join', { conversationId: convId });
                log(`üö™ Joined room: ${convId}`, 'info');
            }

            // Load messages
            loadMessages();
        }

        async function loadMessages() {
            const token = document.getElementById('token').value;
            const serverUrl = document.getElementById('serverUrl').value;
            const conversationId = document.getElementById('conversationId').value;

            if (!conversationId) {
                log('‚ùå Please select or enter a conversation ID first!', 'error');
                return;
            }

            currentConversationId = conversationId;
            log(`üìã Loading messages for conversation: ${conversationId}`, 'info');

            try {
                const response = await fetch(`${serverUrl}/api/chat/conversations/${conversationId}/messages?limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const chatBox = document.getElementById('chatBox');
                    chatBox.innerHTML = '';

                    const messages = data.data.messages || [];
                    log(`‚úÖ Loaded ${messages.length} messages`, 'success');

                    if (messages.length === 0) {
                        chatBox.innerHTML = '<div style="color: #666; text-align: center;">No messages yet. Send the first message!</div>';
                    } else {
                        messages.forEach(msg => {
                            const isSent = msg.senderKey === userKey;
                            const time = new Date(msg.createdAt).toLocaleTimeString();
                            addChatMessage(
                                msg.content,
                                isSent,
                                `${isSent ? 'You' : msg.senderName || msg.senderKey} ‚Ä¢ ${time}`,
                                msg.id || msg.messageId
                            );
                        });
                    }
                } else {
                    log(`‚ùå Error: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå API Error: ${error.message}`, 'error');
            }
        }

        function createConversation() {
            const targetUserKey = document.getElementById('targetUserKey').value;
            const convType = document.getElementById('convType').value;
            const groupName = document.getElementById('groupName').value;

            if (!targetUserKey) {
                log('‚ùå Please enter target user key (User B)!', 'error');
                return;
            }

            if (socket && socket.connected) {
                const convData = {
                    type: convType,
                    participants: [targetUserKey],
                    name: convType === 'group' ? groupName : null
                };
                log(`üí¨ Creating ${convType} conversation with ${targetUserKey}...`, 'info');
                socket.emit('chat:conversation:create', convData);
            } else {
                log('Not connected!', 'error');
            }
        }

        function joinConversation() {
            const conversationId = document.getElementById('conversationId').value;

            if (!conversationId) {
                log('‚ùå Please enter a conversation ID first!', 'error');
                return;
            }

            if (socket && socket.connected) {
                log(`üö™ Joining conversation room: ${conversationId}`, 'info');
                socket.emit('chat:conversation:join', { conversationId: conversationId });
                currentConversationId = conversationId;
            } else {
                log('Not connected!', 'error');
            }
        }

        function sendMessage() {
            const conversationId = document.getElementById('conversationId').value || currentConversationId;
            const content = document.getElementById('messageInput').value;

            if (!conversationId) {
                log('‚ùå No conversation selected!', 'error');
                return;
            }

            if (!content.trim()) {
                log('‚ùå Please enter a message!', 'error');
                return;
            }

            if (socket && socket.connected) {
                const msgData = {
                    conversationId: conversationId,
                    content: content,
                    type: 'text',
                    tempId: 'temp_' + Date.now()
                };
                log(`üì§ Sending: ${content}`, 'info');
                socket.emit('chat:send', msgData);
                document.getElementById('messageInput').value = '';
            } else {
                log('Not connected!', 'error');
            }
        }

        function markAsRead() {
            const conversationId = document.getElementById('conversationId').value || currentConversationId;

            if (!conversationId) {
                log('‚ùå No conversation selected!', 'error');
                return;
            }

            if (socket && socket.connected) {
                log(`üëÅ Marking conversation as read: ${conversationId}`, 'info');
                socket.emit('chat:read', { conversationId: conversationId });
            } else {
                log('Not connected!', 'error');
            }
        }

        function startTyping() {
            const conversationId = document.getElementById('conversationId').value || currentConversationId;

            if (!conversationId) {
                log('‚ùå No conversation selected!', 'error');
                return;
            }

            if (socket && socket.connected) {
                log(`‚å®Ô∏è Sending typing indicator...`, 'info');
                socket.emit('chat:typing', { conversationId: conversationId, isTyping: true });

                // Auto-stop after 2 seconds
                setTimeout(() => {
                    if (socket && socket.connected) {
                        socket.emit('chat:typing', { conversationId: conversationId, isTyping: false });
                        log(`‚å®Ô∏è Stopped typing`, 'info');
                    }
                }, 2000);
            } else {
                log('Not connected!', 'error');
            }
        }

        function deleteMessage(forEveryone) {
            const messageId = document.getElementById('deleteMessageId').value;

            if (!messageId) {
                log('‚ùå Please enter a message ID to delete!', 'error');
                return;
            }

            if (socket && socket.connected) {
                log(`üóëÔ∏è Deleting message ${messageId} (forEveryone: ${forEveryone})...`, 'info');
                socket.emit('chat:delete', {
                    messageId: messageId,
                    forEveryone: forEveryone
                });
            } else {
                log('Not connected!', 'error');
            }
        }

        function clearConversation(forEveryone) {
            const conversationId = document.getElementById('conversationId').value || currentConversationId;

            if (!conversationId) {
                log('‚ùå No conversation selected!', 'error');
                return;
            }

            const confirmMsg = forEveryone
                ? 'Clear ALL messages for EVERYONE in this conversation?'
                : 'Clear messages for yourself only?';

            if (!confirm(confirmMsg)) {
                log('Clear cancelled', 'info');
                return;
            }

            if (socket && socket.connected) {
                log(`üßπ Clearing conversation ${conversationId} (forEveryone: ${forEveryone})...`, 'info');
                socket.emit('chat:conversation:clear', {
                    conversationId: conversationId,
                    forEveryone: forEveryone
                });
            } else {
                log('Not connected!', 'error');
            }
        }

        // Enter key to send message
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            log('User A Test Ready. Enter token and click Connect.', 'info');
        });
    </script>
</body>
</html>

